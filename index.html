<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ArcGIS Enterprise Patch List (Single Page)</title>
<style>
  :root {
    --bg:#f7f4ed; --panel:#ffffff; --fg:#0a1b2b; --muted:#5c6f7b; --border:#d9e2ea;
    --head:#f1f5f2; --chip:#eef2f5; --accent:#146b5f; --accent2:#e07a1f; --danger:#b42318;
    --shadow:0 18px 38px rgba(9,30,66,.12), 0 3px 6px rgba(9,30,66,.08);
    --sticky-top:0px;
    --bg-grad-1:#f8e9d3; --bg-grad-2:#dfeefb; --bg-grad-3:#f7f4ed; --bg-grad-4:#f6f8fb;
    --header-bg-1:rgba(255,255,255,.96); --header-bg-2:rgba(255,255,255,.86);
    --header-glow-1:rgba(20,107,95,.08); --header-glow-2:rgba(224,122,31,.06);
    --header-line:rgba(9,30,66,.05);
    --row-odd:#fcfdfc; --row-hover:#f5f8f7;
    --pill-open:#e9f5f1; --pill-dl:#fff1e5; --pill-hover:#e2f0ec;
    --btn-bg-1:#ffffff; --btn-bg-2:#eef7f4; --btn-hover-1:#f8fffc; --btn-hover-2:#e7f2ee;
    --bar-bg:rgba(255,255,255,.92);
    color-scheme:light;
  }
  [data-theme="dark"] {
    --bg:#0f1418; --panel:#151b21; --fg:#e6edf3; --muted:#a0acb5; --border:#26323a;
    --head:#192128; --chip:#1b252c; --accent:#5ac8b5; --accent2:#f1b66a; --danger:#ff7a6b;
    --shadow:0 18px 38px rgba(0,0,0,.45), 0 3px 6px rgba(0,0,0,.35);
    --bg-grad-1:#1d2a31; --bg-grad-2:#1a212a; --bg-grad-3:#0f1418; --bg-grad-4:#121820;
    --header-bg-1:rgba(16,22,28,.92); --header-bg-2:rgba(16,22,28,.82);
    --header-glow-1:rgba(90,200,181,.12); --header-glow-2:rgba(241,182,106,.10);
    --header-line:rgba(255,255,255,.06);
    --row-odd:#131a20; --row-hover:#1b242b;
    --pill-open:#193430; --pill-dl:#2f2518; --pill-hover:#223039;
    --btn-bg-1:#151b21; --btn-bg-2:#17302b; --btn-hover-1:#1c242b; --btn-hover-2:#1b3a34;
    --bar-bg:rgba(16,22,28,.92);
    color-scheme:dark;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Source Sans 3","Trebuchet MS","Verdana",sans-serif;
    background:
      radial-gradient(1200px 600px at 10% -10%, var(--bg-grad-1) 0%, rgba(248,233,211,0) 60%),
      radial-gradient(900px 700px at 100% 0%, var(--bg-grad-2) 0%, rgba(223,238,251,0) 65%),
      linear-gradient(180deg, var(--bg-grad-3) 0%, var(--bg-grad-4) 100%);
    color:var(--fg);
  }
  header{
    position:sticky;
    top:0;
    z-index:10;
    padding:16px 18px 14px;
    border-bottom:1px solid var(--border);
    background:linear-gradient(135deg, var(--header-bg-1), var(--header-bg-2));
    backdrop-filter:blur(8px);
  }
  header::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(120deg, var(--header-glow-1), var(--header-glow-2)),
      repeating-linear-gradient(90deg, var(--header-line) 0 1px, rgba(9,30,66,0) 1px 14px);
    pointer-events:none;
    opacity:.55;
  }
  header > *{position:relative}
  .hero{display:flex;flex-direction:column;gap:6px}
  .kicker{font-size:11px;letter-spacing:.18em;text-transform:uppercase;color:var(--accent);font-weight:700}
  h1{margin:0;font-size:20px;font-weight:800;font-family:"Oswald","Franklin Gothic Medium","Arial Narrow",sans-serif}
  .sub{margin-top:2px;font-size:12px;color:var(--muted)}
  .bar{
    margin-top:12px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    padding:10px;
    border:1px solid var(--border);
    border-radius:16px;
    background:var(--bar-bg);
    box-shadow:var(--shadow);
  }
  .bar input,.bar select{
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:12px;
    font-size:13px;
    background:var(--panel);
    min-width:180px;
    transition:border-color .2s ease, box-shadow .2s ease;
  }
  .bar input{min-width:320px;flex:1 1 320px}
  .bar input:focus,.bar select:focus{
    outline:none;
    border-color:rgba(20,107,95,.6);
    box-shadow:0 0 0 3px rgba(20,107,95,.12);
  }
  .btn{
    padding:10px 12px;
    border:1px solid rgba(20,107,95,.4);
    border-radius:12px;
    background:linear-gradient(135deg, var(--btn-bg-1), var(--btn-bg-2));
    cursor:pointer;
    font-size:13px;
    font-weight:700;
    color:var(--accent);
  }
  .btn:hover{background:linear-gradient(135deg, var(--btn-hover-1), var(--btn-hover-2))}
  .btn.toggle{border-color:rgba(20,107,95,.55)}
  .theme-toggle{margin-left:auto;min-width:44px;padding:10px}
  .theme-toggle .icon{display:inline-block;font-size:16px;line-height:1}
  .theme-toggle .icon-sun{display:none}
  [data-theme="dark"] .theme-toggle .icon-sun{display:inline-block}
  [data-theme="dark"] .theme-toggle .icon-moon{display:none}
  .menu-active .bar{display:none}
  .patch-filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center;flex:1 1 auto}
  .view-software .patch-filters,.view-menu .patch-filters{display:none}
  .menu-wrap{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .menu-card{border:1px solid var(--border);border-radius:18px;background:var(--panel);box-shadow:var(--shadow);padding:18px}
  .menu-title{font-size:16px;font-weight:800;margin:0 0 6px}
  .menu-sub{font-size:12px;color:var(--muted);margin:0 0 14px}
  .menu-actions{display:flex;flex-wrap:wrap;gap:10px}
  main{padding:18px 18px 30px;max-width:1200px;margin:0 auto}
  .guide{
    display:grid;
    grid-template-columns:1.2fr 1fr;
    gap:12px;
    margin:6px 0 16px;
  }
  .card{
    border:1px solid var(--border);
    border-radius:16px;
    background:var(--panel);
    box-shadow:var(--shadow);
    padding:12px 14px;
  }
  .card-title{
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.18em;
    color:var(--accent);
    font-weight:700;
  }
  .card-body{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.5}
  .card-body ul{margin:6px 0 0 16px;padding:0}
  .card-body li{margin:4px 0}
  .kbd{
    display:inline-block;
    padding:2px 6px;
    border-radius:6px;
    border:1px solid var(--border);
    background:var(--head);
    color:var(--fg);
    font-size:11px;
  }
  .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 14px}
  .badge{
    padding:6px 12px;
    border:1px solid var(--border);
    border-radius:999px;
    font-size:12px;
    background:var(--head);
    box-shadow:0 2px 8px rgba(9,30,66,.06);
  }
  .hint{color:var(--muted);font-size:12px;margin-left:auto}
  .tablewrap{
    border:1px solid var(--border);
    border-radius:18px;
    overflow:hidden;
    background:var(--panel);
    box-shadow:var(--shadow);
    max-height:68vh;
    overflow:auto;
  }
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  .table-head{
    position:sticky;
    top:0;
    z-index:6;
    background:var(--head);
  }
  .table-head thead th{
    position:static;
    background:var(--head);
    border-bottom:1px solid var(--border);
    text-align:left;
    padding:11px 10px;
    font-size:12px;
    white-space:nowrap;
  }
  .col-released{width:120px}
  .col-component{width:140px}
  .col-security{width:90px}
  .col-name{width:auto}
  .col-support{width:180px}
  .col-download{width:220px}
  tbody td{border-top:1px solid var(--border);padding:10px 10px;font-size:13px;vertical-align:top}
  tbody tr:nth-child(odd){background:var(--row-odd)}
  tbody tr:hover{background:var(--row-hover)}
  .wrap{white-space:pre-wrap;word-break:break-word}
  .nowrap{white-space:nowrap}
  .actions{display:flex;flex-wrap:wrap;gap:6px}
  .col-name{font-weight:700;color:var(--fg)}
  .col-date{font-variant-numeric:tabular-nums}
  .col-month{color:var(--muted)}
  .col-component{font-weight:600}
  .col-support .pill{white-space:nowrap}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--chip);
    font-size:12px;
    color:var(--fg);
    text-decoration:none;
    cursor:pointer;
  }
  .pill.open{border-color:rgba(20,107,95,.35);background:var(--pill-open)}
  .pill.dl{border-color:rgba(224,122,31,.35);background:var(--pill-dl)}
  .pill:hover{background:var(--pill-hover)}
  .pill.disabled{opacity:.5;pointer-events:none;cursor:not-allowed}
  .secY{color:var(--danger);font-weight:800}
  .secN{color:var(--muted)}
  footer{padding:14px 18px;border-top:1px solid var(--border);color:var(--muted);font-size:12px;text-align:center}
  .hero,.bar,.tablewrap{animation:fadeInUp .6s ease both}
  .bar{animation-delay:.08s}
  .tablewrap{animation-delay:.16s}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  @media (max-width:900px){
    .bar input{min-width:220px;flex-basis:220px}
    .guide{grid-template-columns:1fr}
    .menu-wrap{grid-template-columns:1fr}
  }
  @media (max-width:600px){
    h1{font-size:18px}
    .bar{padding:8px}
  }
</style>
</head>
<body>
<header>
  <div class="hero">
    <div class="kicker">ArcGIS Enterprise Download</div>
    <h1>ArcGIS Enterprise Download Assist</h1>
    <div class="sub">Select version from dropdown. Click Open/Download buttons for each patch file link.</div>
  </div>

  <div class="bar">
    <button class="btn" id="menuBtn" type="button">Menu</button>
    <button class="btn toggle" id="tabPatch" type="button" aria-pressed="true">Patches</button>
    <button class="btn" id="tabSoftware" type="button" aria-pressed="false">Software</button>
    <button class="btn" id="downloadReg" type="button" data-url="https://raw.githubusercontent.com/tongkhemmathat-dot/ESRI-Patch-list/main/DisableArcGISProUpdates.reg">Download Script ‡∏õ‡∏¥‡∏î Patch ArcGIS Pro</button>
    <button class="btn toggle theme-toggle" id="themeBtn" type="button" aria-pressed="false" aria-label="Toggle theme" title="Toggle theme">
      <span class="icon icon-moon">üåô</span>
      <span class="icon icon-sun">‚òÄÔ∏è</span>
    </button>
  </div>
</header>

<main>
<section id="menuView">
  <div class="menu-wrap">
    <div class="menu-card">
      <h2 class="menu-title">Patch List</h2>
      <p class="menu-sub">Browse and filter ArcGIS Enterprise patches by version.</p>
      <div class="menu-actions">
        <button class="btn toggle" id="menuPatch" type="button">Software Patch</button>
      </div>
    </div>
    <div class="menu-card">
      <h2 class="menu-title">Download Software</h2>
      <p class="menu-sub">Find installers, sizes, and direct downloads.</p>
      <div class="menu-actions">
        <button class="btn toggle" id="menuSoftware" type="button">Software</button>
      </div>
    </div>
    <div class="menu-card">
      <h2 class="menu-title">Script Disable ArcGIS Pro update</h2>
      <p class="menu-sub">Disable ArcGIS Pro update checks at startup.</p>
      <div class="menu-actions">
        <button class="btn" id="menuDownload" type="button">Download Script</button>
      </div>
    </div>
  </div>
</section>

<section id="patchView" style="display:none;">
  <div class="bar" style="margin:0 0 12px;">
    <select id="versionSel" title="Version"></select>
    <input id="q" type="search" placeholder="Search: patch name, ID, summary, URLs ..." />
    <select id="componentSel" title="Component">
      <option value="">All components</option>
      <option>ArcGIS Server</option>
      <option>Portal</option>
      <option>Data Store</option>
      <option>Notebook</option>
      <option>GeoEvent</option>
      <option>Other</option>
    </select>
    <select id="securitySel" title="Security">
      <option value="">Security: All</option>
      <option value="Y">Security = Y</option>
      <option value="N">Security = N</option>
    </select>
    <button class="btn" id="clearBtn">Clear</button>
    <span class="hint" id="status"></span>
  </div>

  <div class="meta">
    <span class="badge" id="verBadge"></span>
    <span class="badge" id="countBadge"></span>
    <span class="badge">Tip: filter by Component or Security for faster navigation.</span>
  </div>

  <div class="tablewrap">
    <table class="table-head">
      <colgroup>
        <col class="col-released"/>
        <col class="col-component"/>
        <col class="col-security"/>
        <col class="col-name"/>
        <col class="col-support"/>
        <col class="col-download"/>
      </colgroup>
      <thead><tr id="thead"></tr></thead>
    </table>
    <table id="tbl" class="table-body">
      <colgroup>
        <col class="col-released"/>
        <col class="col-component"/>
        <col class="col-security"/>
        <col class="col-name"/>
        <col class="col-support"/>
        <col class="col-download"/>
      </colgroup>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</section>

<section id="softwareView" style="display:none;">
  <div class="meta">
    <span class="badge" id="swBadge">Software</span>
    <span class="badge" id="swCount"></span>
    <span class="hint" id="swStatus"></span>
  </div>

  <div class="bar" style="margin:0 0 12px;">
    <select id="swVersionSel" title="Version">
      <option value="">All versions</option>
    </select>
    <select id="swCompSel" title="Component">
      <option value="">All components</option>
      <option value="ArcGIS Server">ArcGIS Server</option>
      <option value="Portal">Portal</option>
      <option value="Data Store">Data Store</option>
      <option value="Notebook">Notebook</option>
      <option value="Web Adaptor">Web Adaptor</option>
      <option value="Desktop">ArcGIS Desktop</option>
      <option value="Pro">ArcGIS Pro</option>
      <option value="Enterprise">Enterprise</option>
      <option value="Other">Other</option>
    </select>
    <input id="swQ" type="search" placeholder="Search filename..." />
    <button class="btn" id="swReload" type="button">Reload</button>
  </div>

  <div class="tablewrap">
    <table class="table-head">
      <colgroup>
        <col style="width:110px"/>
        <col style="width:140px"/>
        <col style="width:auto"/>
        <col style="width:110px"/>
        <col style="width:240px"/>
      </colgroup>
      <thead>
        <tr>
          <th>Version</th>
          <th>Component</th>
          <th>Filename</th>
          <th>Size (GB)</th>
          <th>Links</th>
        </tr>
      </thead>
    </table>
    <table class="table-body">
      <colgroup>
        <col style="width:110px"/>
        <col style="width:140px"/>
        <col style="width:auto"/>
        <col style="width:110px"/>
        <col style="width:240px"/>
      </colgroup>
      <tbody id="swTbody"></tbody>
    </table>
  </div>
</section>
</main>

<footer>
  Powered By Khemmathat for Internal USE ONLY!! (v0.8)
</footer>

<script>
let DATA = {
  "All_Enterprise": {
    "columns": ["Released", "Release Month", "Component", "Security", "Patch Name", "Support Page", "PatchFiles", "__row"],
    "rows": []
  }
};

const PATCHES_JSON_URL = "./data/patches.json";
let lastPatchFetchTs = 0;
let activeSheet = "All_Enterprise";

const themeBtn = document.getElementById("themeBtn");
function applyTheme(mode) {
  document.documentElement.setAttribute("data-theme", mode);
  const label = (mode === "dark") ? "Switch to light mode" : "Switch to dark mode";
  themeBtn.setAttribute("aria-label", label);
  themeBtn.setAttribute("title", label);
  themeBtn.setAttribute("aria-pressed", String(mode === "dark"));
  try { localStorage.setItem("theme", mode); } catch (e) {}
}
const storedTheme = (() => { try { return localStorage.getItem("theme"); } catch (e) { return null; } })();
const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
applyTheme(storedTheme || (prefersDark ? "dark" : "light"));
themeBtn.addEventListener("click", () => {
  const current = document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(current === "dark" ? "light" : "dark");
});

const versionSel = document.getElementById("versionSel");

function rebuildPatchSheetOptions() {
  if (!versionSel) return;
  const sheets = Object.keys(DATA || {});
  const hasAll = sheets.includes("All_Enterprise");
  const versionSheets = sheets
    .filter(s => s !== "All_Enterprise")
    .sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
  const ordered = [];
  if (hasAll) ordered.push("All_Enterprise");
  ordered.push(...versionSheets);
  versionSel.innerHTML = "";
  for (const s of ordered) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = (s === "All_Enterprise") ? "All versions" : s.replaceAll("_", ".");
    versionSel.appendChild(opt);
  }
  const nextActive = ordered.includes(activeSheet)
    ? activeSheet
    : (hasAll ? "All_Enterprise" : ordered[0]);
  activeSheet = nextActive || "All_Enterprise";
  versionSel.value = activeSheet;
}

function rebuildPatchComponentOptions() {
  const compSel = document.getElementById("componentSel");
  if (!compSel) return;
  const sheet = DATA?.All_Enterprise || DATA?.[activeSheet];
  if (!sheet?.columns || !sheet?.rows) return;
  const compIdx = sheet.columns.indexOf("Component");
  if (compIdx < 0) return;
  const comps = Array.from(new Set(sheet.rows.map(r => r[compIdx]).filter(Boolean))).sort((a,b) => String(a).localeCompare(String(b)));
  if (!comps.length) return;
  compSel.innerHTML = '<option value="">All components</option>';
  for (const c of comps) {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    compSel.appendChild(opt);
  }
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function splitUrls(text) {
  const t = String(text || "").trim();
  if (!t) return [];
  return t.split(/\s+/).filter(x => x.toLowerCase().startsWith("http"));
}

function renderLinksCell(val) {
  const urls = splitUrls(val);
  if (!urls.length) return "";
  const maxShow = 2;
  const shown = urls.slice(0, maxShow);
  const rest = urls.slice(maxShow);

  let out = '<div class="actions">';
  for (const u of shown) {
    const esc = escapeHtml(u);
    out += '<a class="pill open" href="' + esc + '" target="_blank" rel="noopener noreferrer">Open</a>';
    out += '<a class="pill dl" href="' + esc + '" target="_blank" rel="noopener noreferrer" download>Download</a>';
  }
  if (rest.length) {
    out += '<a class="pill" href="#" onclick="alert(\'More links:\\n\\n\' + ' + JSON.stringify(rest.join('\n')) + '); return false;">More (' + rest.length + ')</a>';
  }
  out += '</div>';
  return out;
}

function renderSupportCell(val) {
  const urls = splitUrls(val);
  if (!urls.length) {
    const t = String(val||"").trim();
    if (t.toLowerCase().startsWith("http")) urls.push(t);
  }
  if (!urls.length) return "";
  const esc = escapeHtml(urls[0]);
  return '<a class="pill open" href="' + esc + '" target="_blank" rel="noopener noreferrer">Open support page</a>';
}

function extractFirstHttpUrl(val) {
  if (Array.isArray(val)) {
    for (const v of val) {
      const found = extractFirstHttpUrl(v);
      if (found) return found;
    }
    return null;
  }
  const s = String(val || "").trim();
  if (!s) return null;
  const parts = s.split(/\s+/);
  for (const p of parts) {
    if (p.toLowerCase().startsWith("http")) return p;
  }
  return null;
}

function normalizeVersionToToken(versionStr) {
  const s = String(versionStr || "").trim();
  if (!s) return "";
  return s.replaceAll(".", "");
}

function pickPatchFileByVersion(patchFilesArray, versionStr) {
  const token = normalizeVersionToToken(versionStr);
  if (!token) return null;
  const files = Array.isArray(patchFilesArray) ? patchFilesArray : [];
  if (!files.length) return null;
  const patterns = [
    new RegExp(`ArcGIS-${token}-`, "i"),
    new RegExp(`/PFA-${token}-`, "i"),
    new RegExp(`/S-${token}-`, "i")
  ];
  for (const fileUrl of files) {
    const url = String(fileUrl || "").trim();
    if (!url) continue;
    if (!/gisupdates\.esri\.com/i.test(url)) continue;
    if (patterns.some(re => re.test(url))) return url;
  }
  return null;
}

function getRowVersion(rowObj) {
  const fromRow = rowObj?.version || rowObj?.Version || "";
  if (fromRow) return String(fromRow);
  if (String(activeSheet).startsWith("v")) {
    return activeSheet.slice(1).replaceAll("_", ".");
  }
  return "";
}

function getDirectPatchDownloadUrl(rowObj) {
  const raw = rowObj?._raw || rowObj || {};
  const versionStr = getRowVersion(rowObj);
  const patchFiles = raw?.PatchFiles || raw?.patchFiles || raw?.patchfiles;
  if (Array.isArray(patchFiles) && patchFiles.length) {
    const match = pickPatchFileByVersion(patchFiles, versionStr);
    return match || null;
  }
  const preferredKeys = [
    "download_url","download url","download","direct download","download link","file url","file_url","qfe_url","qfe url","url"
  ];
  let directUrl = null;
  const keyMap = new Map(Object.keys(raw).map(k => [String(k).toLowerCase(), k]));
  for (const key of preferredKeys) {
    const rawKey = keyMap.get(key);
    if (!rawKey) continue;
    directUrl = extractFirstHttpUrl(raw[rawKey]);
    if (directUrl) break;
  }
  if (directUrl && /gisupdates\.esri\.com/i.test(directUrl)) return directUrl;
  return null;
}

function renderPatchActionsCell(row, colIndex, columns) {
  const rowObj = colIndex.has("__row")
    ? row[colIndex.get("__row")]
    : Object.fromEntries(columns.map((c, i) => [c, row[i]]));
  const directUrl = getDirectPatchDownloadUrl(rowObj);
  let out = '<div class="actions">';
  if (directUrl) {
    out += '<a class="pill dl" href="' + escapeHtml(directUrl) + '" target="_blank" rel="noopener noreferrer" download>Download patch</a>';
  } else {
    out += '<span class="pill disabled" title="No direct download URL available in data/patches.json">Direct DL N/A</span>';
  }
  out += '</div>';
  return out;
}

function normalizeReleaseDate(val) {
  const s = String(val || "").trim();
  if (!s) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) {
    const mm = m[1].padStart(2, "0");
    const dd = m[2].padStart(2, "0");
    return `${m[3]}-${mm}-${dd}`;
  }
  return s;
}

function releaseMonthFromDate(val) {
  const s = String(val || "").trim();
  if (!s) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s.slice(0, 7);
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) return `${m[3]}-${m[1].padStart(2, "0")}`;
  if (/^\d{4}-\d{2}$/.test(s)) return s;
  return "";
}

function inferPatchComponent(products) {
  const text = String(products || "").toLowerCase();
  if (text.includes("portal")) return "Portal";
  if (text.includes("data store")) return "Data Store";
  if (text.includes("notebook")) return "Notebook";
  if (text.includes("geoevent")) return "GeoEvent";
  if (text.includes("server")) return "ArcGIS Server";
  return "Other";
}

function normalizeSecurity(val) {
  const s = String(val || "").toLowerCase();
  if (s.includes("security") || s === "y" || s === "yes" || s === "true") return "Y";
  return "N";
}

function normalizePatchesJson(raw) {
  if (raw?.All_Enterprise?.columns && raw?.All_Enterprise?.rows) return raw;
  if (raw?.columns && raw?.rows) return { All_Enterprise: raw };
  const columns = ["Released", "Release Month", "Component", "Security", "Patch Name", "Support Page", "PatchFiles", "__row"];
  const data = {};
  const addRow = (sheetKey, row) => {
    if (!data[sheetKey]) data[sheetKey] = { columns: [...columns], rows: [] };
    data[sheetKey].rows.push(row);
  };
  const groups = [];
  if (Array.isArray(raw)) {
    groups.push({ version: null, patches: raw });
  } else if (raw && Array.isArray(raw.Product)) {
    groups.push(...raw.Product);
  } else if (raw && Array.isArray(raw.patches)) {
    groups.push({ version: raw.version || null, patches: raw.patches });
  } else if (raw && typeof raw === "object") {
    for (const [key, val] of Object.entries(raw)) {
      if (Array.isArray(val)) groups.push({ version: key, patches: val });
    }
  }

  for (const g of groups) {
    const groupVersion = g?.version ? String(g.version).trim() : "";
    const patches = Array.isArray(g?.patches) ? g.patches : [];
    for (const p of patches) {
      const rowVersion = groupVersion || String(p?.version || p?.Version || "").trim();
      const sheetKey = rowVersion ? `v${rowVersion.replaceAll(".", "_")}` : "All_Enterprise";
      const released = normalizeReleaseDate(p?.ReleaseDate || p?.Released || p?.released || "");
      const month = releaseMonthFromDate(released);
      const component = inferPatchComponent(p?.Products || p?.Component || p?.component);
      const security = normalizeSecurity(p?.Critical || p?.Security || p?.security);
      const name = p?.Name || p?.["Patch Name"] || p?.patch || "";
      const support = p?.url || p?.["Support Page"] || p?.support || "";
      const patchFiles = p?.PatchFiles || p?.patchFiles || p?.patchfiles || "";
      const rowObj = {
        "Released": released,
        "Release Month": month,
        "Component": component,
        "Security": security,
        "Patch Name": name,
        "Support Page": support,
        "PatchFiles": patchFiles,
        "version": rowVersion,
        _raw: p
      };
      const row = [
        rowObj["Released"],
        rowObj["Release Month"],
        rowObj["Component"],
        rowObj["Security"],
        rowObj["Patch Name"],
        rowObj["Support Page"],
        rowObj["PatchFiles"],
        rowObj
      ];
      addRow("All_Enterprise", row);
      if (sheetKey !== "All_Enterprise") addRow(sheetKey, row);
    }
  }
  return data;
}

async function loadPatchesLatest(force = false) {
  const now = Date.now();
  if (!force && now - lastPatchFetchTs < 3000) return;
  lastPatchFetchTs = now;
  const statusEl = document.getElementById("status");
  if (statusEl) statusEl.textContent = "Loading patches...";
  try {
    const url = `${PATCHES_JSON_URL}?t=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    DATA = normalizePatchesJson(json);
    rebuildPatchSheetOptions();
    rebuildPatchComponentOptions();
    renderTable();
    if (statusEl) statusEl.textContent = "";
  } catch (e) {
    const msg = "Error loading patches: " + (e?.message || e);
    if (statusEl) statusEl.textContent = msg;
    showPatchTableMessage(msg);
  }
}

function showPatchTableMessage(message) {
  const sheet = DATA?.[activeSheet] || DATA?.All_Enterprise;
  const columns = sheet?.columns?.length ? sheet.columns : ["Released", "Component", "Security", "Patch Name", "Support Page"];
  const preferredOrder = ["Released", "Component", "Security", "Patch Name", "Support Page", "Download"];
  const visibleColumns = preferredOrder.filter(c => c === "Download" || columns.includes(c));
  const thead = document.getElementById("thead");
  if (thead) {
    thead.innerHTML = "";
    for (const c of visibleColumns) {
      const th = document.createElement("th");
      th.textContent = c;
      thead.appendChild(th);
    }
  }
  const tbody = document.getElementById("tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  const tr = document.createElement("tr");
  const td = document.createElement("td");
  td.colSpan = Math.max(1, visibleColumns.length);
  td.textContent = message;
  td.className = "wrap";
  tr.appendChild(td);
  tbody.appendChild(tr);
  const verBadge = document.getElementById("verBadge");
  if (verBadge) {
    verBadge.textContent = (activeSheet === "All_Enterprise") ? "Version: All" : ("Version: " + activeSheet.replaceAll("_","."));
  }
  const countBadge = document.getElementById("countBadge");
  if (countBadge) countBadge.textContent = "Rows: 0";
}

function renderTable() {
  const sheet = DATA?.[activeSheet] || DATA?.All_Enterprise;
  if (!sheet) return;
  const {columns, rows} = sheet;
  const preferredOrder = ["Released", "Component", "Security", "Patch Name", "Support Page", "Download"];
  const visibleColumns = preferredOrder.filter(c => c === "Download" || columns.includes(c));
  const colIndex = new Map(columns.map((c,i)=>[c,i]));
  const q = document.getElementById("q").value.trim().toLowerCase();
  const comp = document.getElementById("componentSel").value.trim().toLowerCase();
  const sec = document.getElementById("securitySel").value.trim();
  const compIdx = colIndex.has("Component") ? colIndex.get("Component") : -1;
  const secIdx = colIndex.has("Security") ? colIndex.get("Security") : -1;

  const thead = document.getElementById("thead");
  if (thead) {
    thead.innerHTML = "";
    for (const c of visibleColumns) {
      const th = document.createElement("th");
      th.textContent = c;
      thead.appendChild(th);
    }
  }

  const filtered = rows.filter(r => {
    const norm = (v) => String(v || "").trim();
    const releasedIdx = colIndex.get("Released");
    const nameIdx = colIndex.get("Patch Name");
    const supportIdx = colIndex.get("Support Page");
    if (releasedIdx !== undefined && nameIdx !== undefined && supportIdx !== undefined) {
      const isHeaderRow = norm(r[releasedIdx]) === "Released" &&
        norm(r[nameIdx]) === "Patch Name" &&
        norm(r[supportIdx]) === "Support Page";
      if (isHeaderRow) return false;
    }
    if (comp && compIdx >= 0) {
      const v = String(r[compIdx]||"").toLowerCase();
      if (v !== comp) return false;
    }
    if (sec && secIdx >= 0) {
      const v = String(r[secIdx]||"");
      if (v !== sec) return false;
    }
    if (q) {
      const joined = r.map(x=>String(x||"")).join(" ").toLowerCase();
      if (!joined.includes(q)) return false;
    }
    return true;
  });

  const HARD_LIMIT = 4000;
  const renderRows = filtered.slice(0, HARD_LIMIT);
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  for (const r of renderRows) {
    const tr = document.createElement("tr");
    for (const col of visibleColumns) {
      const i = colIndex.get(col);
      const td = document.createElement("td");
      const val = r[i] ?? "";
      const colLow = col.toLowerCase();

      if (colLow === "download" || colLow === "links") {
        td.innerHTML = renderPatchActionsCell(r, colIndex, columns);
      } else if (colLow.includes("download") && colLow.includes("url")) {
        td.innerHTML = renderLinksCell(val);
      } else if (colLow.includes("support")) {
        td.innerHTML = renderSupportCell(val);
      } else if (colLow === "security") {
        const v = String(val||"");
        td.textContent = v;
        td.className = (v === "Y") ? "nowrap secY" : "nowrap secN";
      } else if (colLow === "released") {
        td.textContent = String(val||"");
        td.className = "nowrap col-date";
      } else if (colLow === "component") {
        td.textContent = String(val||"");
        td.className = "nowrap col-component";
      } else if (colLow.includes("summary") || colLow.includes("patch name") || colLow.includes("name")) {
        td.textContent = String(val||"");
        td.className = "wrap col-name";
      } else {
        td.textContent = String(val||"");
        td.className = "nowrap";
      }
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  document.getElementById("verBadge").textContent =
    (activeSheet === "All_Enterprise") ? "Version: All" : ("Version: " + activeSheet.replaceAll("_","."));
  document.getElementById("countBadge").textContent =
    "Rows: " + filtered.length.toLocaleString() + " (rendered " + renderRows.length.toLocaleString() + ")";
  document.getElementById("status").textContent =
    (filtered.length > HARD_LIMIT) ? ("Showing first " + HARD_LIMIT.toLocaleString() + " rows. Refine filters.") : "";
}

versionSel.addEventListener("change", () => {
  activeSheet = versionSel.value;
  document.getElementById("q").value = "";
  renderTable();
});
document.getElementById("q").addEventListener("input", () => renderTable());
document.getElementById("componentSel").addEventListener("change", () => renderTable());
document.getElementById("securitySel").addEventListener("change", () => renderTable());
document.getElementById("clearBtn").addEventListener("click", () => {
  document.getElementById("q").value = "";
  document.getElementById("componentSel").value = "";
  document.getElementById("securitySel").value = "";
  renderTable();
});

document.addEventListener("DOMContentLoaded", () => loadPatchesLatest(true));
</script>

<script>
// ===== Software download view (from Google Sheet CSV) =====
const SOFTWARE_CSV_URL = 'https://docs.google.com/spreadsheets/d/1XU3pUMOnohtXhxOKH0OJqe5nPWOQHwgdl6NDbhPtwD0/gviz/tq?tqx=out:csv&sheet=ArcGIS_DirectDL_Recursive';
let SOFTWARE_ROWS = [];

function parseCsv(text) {
  const rows = [];
  let row = [], cur = "", inQ = false;
  for (let i=0;i<text.length;i++) {
    const ch = text[i], nx = text[i+1];
    if (ch === '"' && inQ && nx === '"') { cur += '"'; i++; continue; }
    if (ch === '"') { inQ = !inQ; continue; }
    if (!inQ && ch === ',') { row.push(cur); cur=""; continue; }
    if (!inQ && (ch === '\n' || ch === '\r')) {
      if (ch === '\r' && nx === '\n') i++;
      row.push(cur); rows.push(row);
      row = []; cur=""; continue;
    }
    cur += ch;
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows.map(r => r.map(c => (c ?? '').trim()));
}

function normalizeProVersion(digits) {
  const s = String(digits || '');
  if (s.length === 2) return `${s[0]}.${s[1]}`;
  if (s.length === 3) return `${s[0]}.${s[1]}.${s[2]}`;
  if (s.length === 4) return `${s[0]}.${s[1]}.${s.slice(2)}`;
  return '';
}

function parseYearSubVersion_(s) {
  const text = String(s || '');
  let m = text.match(/(?:^|[^0-9])(20\d{2})[_\-. ](\d{1,2})(?:[_\-. ]|[^0-9]|$)/);
  if (m) return `${m[1]}.${m[2]}`;
  m = text.match(/(?:^|[^0-9])(20\d{2})(?:[^0-9]|$)/);
  if (m) return `${m[1]}`;
  return null;
}

function parseEnterprise12x_(filename, folderPath) {
  const fn = String(filename || '');
  const fp = String(folderPath || '');
  let m = fn.match(/(?:^|[^0-9])(12\d)(?:[_\-. ]|[^0-9]|$)/);
  if (!m) m = fp.match(/(?:^|[^0-9])(12\d)(?:[_\-. ]|[^0-9]|$)/);
  if (!m) return null;
  const digits = m[1];
  const num = Number(digits);
  if (num < 120 || num > 129) return null;
  return `12.${digits[2]}`;
}

function inferVersion(filename, folderPath, component) {
  const fp = (folderPath || '');
  const fn = (filename || '');
  let m = fp.match(/ArcGISPro(\d{2,4})\b/i) || fn.match(/ArcGISPro_(\d{2,4})\b/i) || fn.match(/ArcGIS_Pro_(\d{2,4})\b/i);
  if (m) {
    const v = normalizeProVersion(m[1]);
    if (v) return v;
  }

  if (component === 'License Manager' || component === 'ArcGIS Monitor' || component === 'ArcGIS Insights') {
    const ym = parseYearSubVersion_(fn) || parseYearSubVersion_(fp);
    if (ym) return ym;
  }

  const enterpriseComponents = new Set(['ArcGIS Server', 'Portal', 'Data Store', 'Notebook', 'Web Adaptor']);
  if (enterpriseComponents.has(component)) {
    const v12 = parseEnterprise12x_(fn, fp);
    if (v12) return v12;
  }

  m = fp.match(/\b11\.(\d)\b/);
  if (m) return `11.${m[1]}`;
  m = fp.match(/ArcGIS(1\d{2,4})\b/i);
  if (m) {
    const s = m[1];
    if (s.length === 3 && s.startsWith('11')) return `11.${s[2]}`;
    if (s.length === 4 && s.startsWith('10')) return `10.${s[2]}.${s[3]}`;
    if (s.length === 5 && s.startsWith('10')) return `10.${s[2]}.${s.slice(3)}`;
  }

  m = fp.match(/\b(\d{1,2}\.\d{1,2}\.\d{1,2})\b/);
  if (m) return m[1];
  m = fp.match(/\b(\d{1,2}\.\d{1,2})\b/);
  if (m) return m[1];
  return 'Unknown';
}

// Temporary checks (uncomment to verify)
// console.assert(inferVersion("ArcGIS_Server_Windows_120_111111.exe", "", "ArcGIS Server") === "12.0", "12.0 infer failed");
// console.assert(inferVersion("ArcGIS_Server_Windows_121_111111.exe", "", "ArcGIS Server") === "12.1", "12.1 infer failed");
// console.assert(inferVersion("ArcGIS_Insights_Windows_2023_1_185917.exe", "", "ArcGIS Insights") === "2023.1", "Insights year infer failed");

function inferComponent(filename, folderPath) {
  const n = (filename || '').toLowerCase();
  const fp = (folderPath || '').toLowerCase();
  if (n.includes('arcgis_insights') || n.includes('insights')) return 'ArcGIS Insights';
  if (n.includes('arcgis_monitor') || n.startsWith('arcgis_monitor') || fp.includes('arcgis_monitor') || fp.includes('arcgis monitor')) return 'ArcGIS Monitor';
  if (n.includes('license_manager') || n.includes('licensemanager') || fp.includes('license manager') || fp.includes('license_manager') || fp.includes('licensemanager')) return 'License Manager';
  if (n.includes('arcgis_server')) return 'ArcGIS Server';
  if (n.startsWith('portal')) return 'Portal';
  if (n.includes('datastore')) return 'Data Store';
  if (n.includes('notebook')) return 'Notebook';
  if (n.includes('web_adaptor') || n.includes('webadaptor') || n.includes('web adaptor')) return 'Web Adaptor';
  if (n.includes('desktop')) return 'Desktop';
  if (n.includes('arcgis_pro') || n.includes('arcgispro') || n.includes('pro_')) return 'Pro';
  if (n.includes('enterprise')) return 'Enterprise';
  if (n.includes('server')) return 'ArcGIS Server';
  return 'Other';
}

async function loadSoftwareFromSheet() {
  const swStatus = document.getElementById('swStatus');
  swStatus.textContent = 'Loading software list...';
  const res = await fetch(SOFTWARE_CSV_URL, { cache: 'no-store' });
  if (!res.ok) throw new Error('Failed to fetch CSV: HTTP ' + res.status);
  const txt = await res.text();
  const rows = parseCsv(txt);
  const header = rows[0] || [];

  const idx = {
    folder: header.indexOf('Folder Path'),
    name: header.indexOf('Filename'),
    size: header.indexOf('Size (GB)'),
    dl: header.indexOf('Direct Download'),
    view: header.indexOf('Web View'),
    updated: header.indexOf('Last Updated'),
  };
  if (idx.name < 0 || idx.dl < 0) {
    throw new Error("CSV header missing required columns: 'Filename' and 'Direct Download'");
  }

  const out = [];
  for (let i=1;i<rows.length;i++) {
    const r = rows[i];
    const filename = (r[idx.name] || '').trim();
    if (!filename) continue;
    if (!filename.startsWith('ArcGIS') && !filename.startsWith('Portal')) continue;

    const folderPath = idx.folder >= 0 ? (r[idx.folder] || '') : '';
    const component = inferComponent(filename, folderPath);
    const version = inferVersion(filename, folderPath, component) || 'Unknown';

    out.push({
      version,
      component,
      filename,
      sizeGB: idx.size >= 0 ? (r[idx.size] || '') : '',
      direct: (r[idx.dl] || ''),
      view: idx.view >= 0 ? (r[idx.view] || '') : '',
      updated: idx.updated >= 0 ? (r[idx.updated] || '') : '',
      folderPath
    });
  }

  SOFTWARE_ROWS = out;
  buildVersionDropdown();
  buildSoftwareComponentDropdown();
  renderSoftware();
  swStatus.textContent = `Loaded ${out.length} items.`;
}

function versionSortKey(v) {
  if (v === 'Unknown') return { type: 9 };
  const parts = String(v).split('.').map(p => Number(p));
  if (parts.every(p => Number.isFinite(p))) return { type: 1, parts };
  return { type: 5, text: String(v) };
}

function compareVersions(a, b) {
  const ka = versionSortKey(a);
  const kb = versionSortKey(b);
  if (ka.type !== kb.type) return ka.type - kb.type;
  if (ka.type === 1) {
    const len = Math.max(ka.parts.length, kb.parts.length);
    for (let i = 0; i < len; i++) {
      const da = ka.parts[i] ?? 0;
      const db = kb.parts[i] ?? 0;
      if (da !== db) return da - db;
    }
    return 0;
  }
  if (ka.type === 5) return ka.text.localeCompare(kb.text);
  return 0;
}

function buildVersionDropdown() {
  const sel = document.getElementById('swVersionSel');
  if (!sel) return;
  const prev = sel.value;
  const versions = Array.from(new Set(SOFTWARE_ROWS.map(x => x.version).filter(Boolean)));
  const known = versions.filter(v => v !== 'Unknown')
    .sort(compareVersions);
  const ordered = known.concat(versions.includes('Unknown') ? ['Unknown'] : []);
  sel.innerHTML = '<option value="">All versions</option>';
  for (const v of ordered) {
    const o = document.createElement('option');
    o.value = v; o.textContent = v;
    sel.appendChild(o);
  }
  sel.value = ordered.includes(prev) ? prev : '';
}

function buildSoftwareComponentDropdown() {
  const compSel = document.getElementById('swCompSel');
  if (!compSel) return;
  const prevComp = compSel.value;
  const comps = Array.from(new Set(SOFTWARE_ROWS.map(r => r.component).filter(Boolean)));
  const preferred = [
    'ArcGIS Server',
    'Portal',
    'Data Store',
    'Notebook',
    'Web Adaptor',
    'ArcGIS Monitor',
    'License Manager',
    'Pro',
    'Desktop',
    'Enterprise',
    'Other'
  ];
  const remaining = comps.filter(c => !preferred.includes(c)).sort((a,b) => a.localeCompare(b));
  const orderedComps = preferred.filter(c => comps.includes(c)).concat(remaining);
  compSel.innerHTML = '<option value="">All components</option>';
  for (const c of orderedComps) {
    const o = document.createElement('option');
    o.value = c; o.textContent = c;
    compSel.appendChild(o);
  }
  compSel.value = orderedComps.includes(prevComp) ? prevComp : '';
}

function renderSoftware() {
  const v = document.getElementById('swVersionSel').value;
  const c = document.getElementById('swCompSel').value;
  const q = (document.getElementById('swQ').value || '').toLowerCase().trim();

  let rows = SOFTWARE_ROWS.slice();
  if (v) rows = rows.filter(r => r.version === v);
  if (c) rows = rows.filter(r => r.component === c);
  if (q) rows = rows.filter(r => (r.filename || '').toLowerCase().includes(q));

  document.getElementById('swBadge').textContent = v ? `Software version: ${v}` : 'Software: All versions';
  document.getElementById('swCount').textContent = `Items: ${rows.length}`;

  const tb = document.getElementById('swTbody');
  tb.innerHTML = rows.map(r => `
    <tr>
      <td class="nowrap">${escapeHtml(r.version === 'Unknown' ? '‚Äî' : (r.version || ''))}</td>
      <td class="nowrap">${escapeHtml(r.component || '')}</td>
      <td class="wrap">${escapeHtml(r.filename || '')}</td>
      <td class="nowrap">${escapeHtml(r.sizeGB || '')}</td>
      <td>
        <div class="actions">
          ${r.view ? `<a class="pill open" href="${escapeHtml(r.view)}" target="_blank" rel="noopener noreferrer">Open</a>` : ''}
          ${r.direct ? `<a class="pill dl" href="${escapeHtml(r.direct)}" target="_blank" rel="noopener noreferrer" download>Download</a>` : ''}
        </div>
      </td>
    </tr>
  `).join('');
}

// Tabs + menu
const menuView = document.getElementById('menuView');
const menuBtn = document.getElementById('menuBtn');
const menuPatch = document.getElementById('menuPatch');
const menuSoftware = document.getElementById('menuSoftware');
const menuDownload = document.getElementById('menuDownload');

const tabPatch = document.getElementById('tabPatch');
const tabSoftware = document.getElementById('tabSoftware');
const patchView = document.getElementById('patchView');
const softwareView = document.getElementById('softwareView');

function setView(view, updateHash = true) {
  const isMenu = view === 'menu';
  const isPatch = view === 'patch';
  const isSoftware = view === 'software';

  menuView.style.display = isMenu ? '' : 'none';
  patchView.style.display = isPatch ? '' : 'none';
  softwareView.style.display = isSoftware ? '' : 'none';

  document.body.classList.toggle('view-menu', isMenu);
  document.body.classList.toggle('view-patch', isPatch);
  document.body.classList.toggle('view-software', isSoftware);
  tabPatch.classList.toggle('toggle', isPatch);
  tabSoftware.classList.toggle('toggle', isSoftware);
  tabPatch.setAttribute('aria-pressed', String(isPatch));
  tabSoftware.setAttribute('aria-pressed', String(isSoftware));

  document.body.classList.toggle('menu-active', isMenu);
  if (isPatch) loadPatchesLatest(true);
  if (updateHash) {
    const hash = isMenu ? '#menu' : (isPatch ? '#patch' : '#software');
    history.replaceState(null, '', hash);
  }
  window.scrollTo({ top: 0, behavior: 'auto' });
}

async function showSoftware() {
  setView('software');
  if (!SOFTWARE_ROWS.length) {
    try { await loadSoftwareFromSheet(); }
    catch (e) {
      document.getElementById('swStatus').textContent = 'Error: ' + (e?.message || e);
    }
  }
}

menuBtn?.addEventListener('click', () => setView('menu'));
menuPatch?.addEventListener('click', () => setView('patch'));
menuSoftware?.addEventListener('click', showSoftware);
menuDownload?.addEventListener('click', () => downloadBtn?.click());
tabPatch?.addEventListener('click', () => setView('patch'));
tabSoftware?.addEventListener('click', showSoftware);

document.getElementById('swVersionSel')?.addEventListener('change', renderSoftware);
document.getElementById('swCompSel')?.addEventListener('change', renderSoftware);
document.getElementById('swQ')?.addEventListener('input', renderSoftware);
document.getElementById('swReload')?.addEventListener('click', loadSoftwareFromSheet);

const downloadBtn = document.getElementById('downloadReg');
const hash = (location.hash || '').toLowerCase();
if (hash === '#software') {
  showSoftware();
} else if (hash === '#patch') {
  setView('patch', false);
} else {
  setView('menu', false);
}

downloadBtn?.addEventListener('click', async () => {
  const url = downloadBtn.getAttribute('data-url');
  if (!url) return;
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const blob = await res.blob();
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'DisableArcGISProUpdates.reg';
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(link.href);
  } catch (e) {
    window.open(url, '_blank', 'noopener,noreferrer');
  }
});
</script>

</body>
</html>



